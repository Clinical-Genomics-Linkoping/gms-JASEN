Bootstrap:docker
From:nfcore/base:latest

%labels
	MAINTAINER Isak Sylvin <isak.sylvin@scilifelab.se>
	DESCRIPTION Singularity container for JASEN microbiology WGS pipeline
	VERSION 0.1.0

%environment
        export PATH="/opt/conda/bin:$PATH"
        export PATH="/opt/conda/envs/jasen/bin:$PATH"
        export PATH="/usr/bin:$PATH"
        export PYTHONPATH="/opt/conda/envs/jasen/lib/python3.7/site-packages"
        export BASH_ENV="/conda_init.sh:$BASH_ENV"
	export PICARD_HOME=/opt/conda/envs/jasen/share/picard-2.20.3-0/
	export PERL5LIB=$PERL5LIB:/opt/conda/envs/jasen/lib/site_perl/5.26.2/
	umask 0002

%files
        nextflow /
        conda_init.sh /
        ../nextflow.config /

%post
        apt -y update
        apt -y install build-essential make curl unzip 
        ln -s /opt/conda/lib/libcrypto.so.1.1 /opt/conda/lib/libcrypto.so.1.0.0
        #apt -y install default-jdk default-jre
        mkdir /scratch/

        /usr/bin/git clone --recurse-submodules --single-branch --branch polishing  https://github.com/genomic-medicine-sweden/JASEN.git
        /opt/conda/bin/conda env create -f JASEN/container/environment.yml
        ln -s /opt/conda/envs/jasen/lib/libcrypto.so.1.1 /opt/conda/envs/jasen/lib/libcrypto.so.1.0.0


        # Conda setup attempts
        /bin/cat conda_init.sh >> ~/.bashrc
        /opt/conda/bin/conda init bash
        . /opt/conda/etc/profile.d/conda.sh
        conda config --set auto_activate_base true


        ##Requires activate to work (term reload) and JAVA.
        #. /opt/conda/bin/activate jasen
        #/usr/bin/yes | /opt/conda/bin/conda install -c anaconda openjdk
        #/usr/bin/curl -s https://get.nextflow.io | /bin/bash
        #. /opt/conda/bin/deactivate

        /bin/mv /nextflow /bin/ 

%runscript
        . /opt/conda/etc/profile.d/conda.sh

        . /opt/conda/bin/activate jasen
	exec "$@"`
        . /opt/conda/bin/deactivate
